name: Pre-publish (validation only)

on:
  push:
    tags:
      - 'v*.*.*-*.*'

jobs:
  prepublish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------
      # 1 tag 格式强校验（pre / beta / rc）
      # ---------------------------------
      - name: Validate pre publish tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-(dev|pre|beta|rc)\.[0-9]+$ ]]; then
            echo "::error::Invalid prerelease tag: $TAG"
            exit 1
          fi

      # ---------------------------------
      # 2 tag ↔ pubspec 版本校验
      # ---------------------------------
      - name: Validate tag matches pubspec version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')

          echo "Tag version:      $TAG_VERSION"
          echo "Pubspec version:  $PUBSPEC_VERSION"

          if [[ ! "$PUBSPEC_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-(pre|beta|rc)\.[0-9]+$ ]]; then
            echo "::error::Pubspec version is not a prerelease version"
            exit 1
          fi

          if [ "$TAG_VERSION" != "$PUBSPEC_VERSION" ]; then
            echo "::error::Tag version does not match pubspec.yaml version"
            exit 1
          fi

      # ---------------------------------
      # 3 解析最低 Flutter SDK
      # ---------------------------------
      - name: Extract minimum Flutter version
        id: min_flutter
        run: |
          LINE=$(grep -E "flutter:\s*'>=" pubspec.yaml | head -n 1)

          if [ -z "$LINE" ]; then
            echo "::error::Missing environment:flutter constraint"
            exit 1
          fi

          MIN=$(echo "$LINE" | sed -E 's/.*>=([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$MIN" >> $GITHUB_OUTPUT
          echo "Minimum Flutter: $MIN"

      # ---------------------------------
      # 4 最低 Flutter：兼容性校验
      # ---------------------------------
      - name: Setup Flutter (minimum)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.min_flutter.outputs.version }}
          channel: stable
          cache: true

      - name: Pub get (min Flutter)
        run: flutter pub get

      - name: Analyze (min Flutter)
        run: flutter analyze --fatal-infos --fatal-warnings

      # ---------------------------------
      # 5 Stable Flutter：规范校验
      # ---------------------------------
      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Pub get (stable)
        run: flutter pub get

      - name: Dart format check (lib/, stable)
        run: dart format --output=none --set-exit-if-changed lib

      # ---------------------------------
      # 6 执行 test
      # ---------------------------------
      - name: Flutter test
        run: flutter test

      - name: Publish dry-run
        run: flutter pub publish --dry-run